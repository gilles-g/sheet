name: Panther Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  panther-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, pdo
        tools: composer:v2
        coverage: none

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    - name: Start Xvfb
      run: |
        Xvfb :0 -screen 0 1920x1080x24 &
        echo "DISPLAY=:0" >> $GITHUB_ENV

    - name: Get Composer Cache Directory
      id: composer-cache
      working-directory: examples/symfony
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      working-directory: examples/symfony
      run: composer install --prefer-dist --no-progress --no-interaction

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build stimulus-sheet distribution
      run: |
        npm ci
        npm run create-zip

    - name: Install stimulus-sheet from local zip
      working-directory: examples/symfony
      run: |
        # Extract the zip distribution
        unzip ../../stimulus-sheet-*.zip
        
        # Update package.json to use local package
        node -e "
        const fs = require('fs');
        const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
        pkg.dependencies['stimulus-sheet'] = 'file:./package';
        fs.writeFileSync('package.json', JSON.stringify(pkg, null, 4));
        "
        
        # Show the updated dependency
        echo "Updated stimulus-sheet dependency:"
        grep -A1 "stimulus-sheet" package.json

    - name: Install NPM dependencies
      working-directory: examples/symfony
      run: npm install

    - name: Build assets
      working-directory: examples/symfony
      run: npm run build

    - name: Create .env.test.local file
      working-directory: examples/symfony
      run: |
        cat > .env.test.local << EOF
        DATABASE_URL="sqlite:///%kernel.project_dir%/var/test.db"
        PANTHER_APP_ENV=test
        PANTHER_WEB_SERVER_DIR=public
        PANTHER_ERROR_SCREENSHOT_DIR=./var/error-screenshots
        EOF

    - name: Create database schema
      working-directory: examples/symfony
      run: |
        php bin/console doctrine:database:create --env=test --no-interaction
        php bin/console doctrine:schema:update --force --env=test --no-interaction
        
    - name: Warm up cache for test environment
      working-directory: examples/symfony
      run: |
        php bin/console cache:clear --env=test --no-interaction
        php bin/console cache:warmup --env=test --no-interaction

    - name: Run Panther tests
      working-directory: examples/symfony
      run: php bin/phpunit tests/SheetTest.php --testdox
      env:
        PANTHER_NO_HEADLESS: 0
        PANTHER_CHROME_ARGUMENTS: "--disable-dev-shm-usage --no-sandbox"
