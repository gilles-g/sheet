name: Panther Tests with Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  panther-docker-tests:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env.test.local file
      working-directory: examples/symfony
      run: |
        cat > .env.test.local << EOF
        DATABASE_URL="mysql://app:!ChangeMe!@database:3306/app_test?serverVersion=11.4-MariaDB&charset=utf8mb4"
        PANTHER_WEB_SERVER_DIR=public
        PANTHER_APP_ENV=test
        PANTHER_NO_SANDBOX=1
        PANTHER_CHROME_ARGUMENTS="--disable-dev-shm-usage --no-sandbox --headless --disable-gpu"
        PANTHER_EXTERNAL_BASE_URI=http://nginx
        EOF

    - name: Configure Git for private repo access
      run: git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

    - name: Build and start Docker containers
      working-directory: examples/symfony
      run: |
        docker compose -f compose.ci.yaml build --build-arg BUILDKIT_INLINE_CACHE=1
        docker compose -f compose.ci.yaml up -d
        
    - name: Wait for services to be ready
      working-directory: examples/symfony
      run: |
        echo "Waiting for database to be ready..."
        timeout 60 bash -c 'until docker compose -f compose.ci.yaml exec -T database healthcheck.sh --connect; do sleep 2; done'
        echo "Waiting for PHP service to be ready..."
        sleep 5

    - name: Create database schema
      working-directory: examples/symfony
      run: |
        docker compose -f compose.ci.yaml exec -T php php bin/console doctrine:database:create --env=test --no-interaction || true
        docker compose -f compose.ci.yaml exec -T php php bin/console doctrine:migrations:migrate --env=test --no-interaction

    - name: Run Panther tests
      working-directory: examples/symfony
      run: |
        docker compose -f compose.ci.yaml exec -T php php bin/phpunit tests/SheetTest.php --testdox

    - name: Show logs on failure
      if: failure()
      working-directory: examples/symfony
      run: |
        echo "=== PHP Logs ==="
        docker compose -f compose.ci.yaml logs php
        echo "=== Nginx Logs ==="
        docker compose -f compose.ci.yaml logs nginx
        echo "=== Database Logs ==="
        docker compose -f compose.ci.yaml logs database

    - name: Cleanup
      if: always()
      working-directory: examples/symfony
      run: docker compose -f compose.ci.yaml down -v
